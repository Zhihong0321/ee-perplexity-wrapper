<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat List - Perplexity Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card {
            @apply bg-white rounded-lg shadow-md p-6 border border-gray-200;
        }
        .btn-primary {
            @apply bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors;
        }
        .btn-danger {
            @apply bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 transition-colors text-sm;
        }
        .btn-danger:disabled {
            @apply bg-gray-400 cursor-not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Chat List</h1>
                    <p class="text-gray-600">Manage your Perplexity AI conversations</p>
                </div>
                <a href="/" class="btn-secondary">‚Üê Back to Dashboard</a>
            </div>
        </header>

        <div class="card mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Account</label>
                <div id="accountButtons" class="flex flex-wrap gap-2">
                    <div class="text-gray-500">Loading accounts...</div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" id="searchInput" placeholder="Search chats..." 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <div class="card">
            <div id="statusMessage" class="hidden mb-4 p-3 rounded-md"></div>
            <div id="loadingIndicator" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Loading chats...</p>
            </div>
            <div id="chatList" class="space-y-4"></div>
            <div id="emptyState" class="hidden text-center py-12">
                <p class="text-gray-500">No chats found. Select an account and click "Load Chats".</p>
            </div>
        </div>
    </div>

    <script>
        let currentAccount = '';
        let currentOffset = 0;
        const threadsPerPage = 20;

        // Load accounts on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAccounts();
            
            // Event listener for search
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadChats();
            });
        });

        async function loadAccounts() {
            try {
                const response = await fetch('/api/account/list');
                const result = await response.json();
                
                const container = document.getElementById('accountButtons');
                container.innerHTML = '';
                
                if (result.status === 'success' && result.accounts) {
                    const accountNames = Object.keys(result.accounts);
                    if (accountNames.length === 0) {
                        container.innerHTML = '<div class="text-gray-500">No accounts found. Add accounts in the dashboard.</div>';
                        return;
                    }
                    
                    accountNames.forEach(accountName => {
                        const button = document.createElement('button');
                        button.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-blue-600 hover:text-white transition-colors';
                        button.textContent = accountName;
                        button.dataset.account = accountName;
                        button.onclick = () => selectAccount(accountName, button);
                        container.appendChild(button);
                    });
                } else {
                    container.innerHTML = '<div class="text-red-500">Failed to load accounts</div>';
                }
            } catch (error) {
                document.getElementById('accountButtons').innerHTML = '<div class="text-red-500">Error: ' + error.message + '</div>';
            }
        }
        
        function selectAccount(accountName, clickedButton) {
            // Update visual state
            document.querySelectorAll('#accountButtons button').forEach(btn => {
                btn.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-blue-600 hover:text-white transition-colors';
            });
            clickedButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md';
            
            // Set current account and load chats
            currentAccount = accountName;
            loadChats();
        }

        async function loadChats() {
            const searchTerm = document.getElementById('searchInput').value;
            
            if (!currentAccount) {
                showStatus('Please select an account first', 'error');
                return;
            }

            showLoading(true);
            currentOffset = 0; // Reset offset for new search
            
            try {
                const response = await fetch(
                    `/api/threads?account_name=${encodeURIComponent(currentAccount)}&limit=${threadsPerPage}&offset=${currentOffset}&search_term=${encodeURIComponent(searchTerm)}`
                );
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayChats(result.data.threads || [], true);
                } else {
                    showStatus(result.message || 'Failed to load chats', 'error');
                }
            } catch (error) {
                showStatus('Error loading chats: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayChats(threads, isFirstLoad = false) {
            const chatList = document.getElementById('chatList');
            const emptyState = document.getElementById('emptyState');
            
            if (isFirstLoad) {
                chatList.innerHTML = '';
            }
            
            if (!threads || threads.length === 0) {
                if (isFirstLoad) {
                    chatList.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                }
                return;
            }
            
            chatList.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            threads.forEach(thread => {
                const chatItem = createChatItem(thread);
                chatList.appendChild(chatItem);
            });
        }

        function createChatItem(thread) {
            const div = document.createElement('div');
            div.className = 'border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors';
            div.dataset.threadId = thread.uuid || thread.id || '';
            
            // Format date
            const date = thread.created_at ? new Date(thread.created_at).toLocaleString() : 'Unknown date';
            
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0 pr-4">
                        <h3 class="text-lg font-medium text-gray-900 truncate">${thread.title || 'Untitled Chat'}</h3>
                        <p class="text-sm text-gray-600 mt-1">${date}</p>
                        ${thread.last_query ? `<p class="text-sm text-gray-500 mt-2 truncate">${thread.last_query}</p>` : ''}
                    </div>
                    <button onclick="deleteChat('${thread.uuid || thread.id || ''}', this)" 
                        class="btn-danger shrink-0">
                        Delete
                    </button>
                </div>
            `;
            
            return div;
        }

        async function deleteChat(threadId, button) {
            if (!threadId) {
                showStatus('Invalid thread ID', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
                return;
            }
            
            // Disable button and show loading state
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Deleting...';
            
            try {
                const response = await fetch(
                    `/api/threads/${threadId}?account_name=${encodeURIComponent(currentAccount)}`,
                    { method: 'DELETE' }
                );
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Remove the chat item from DOM
                    const chatItem = button.closest('[data-thread-id]');
                    chatItem.remove();
                    showStatus('Chat deleted successfully', 'success');
                    
                    // Check if we need to hide the empty state
                    const chatList = document.getElementById('chatList');
                    if (chatList.children.length === 0) {
                        document.getElementById('emptyState').classList.remove('hidden');
                        chatList.classList.add('hidden');
                    }
                } else {
                    showStatus(result.message || 'Failed to delete chat', 'error');
                }
            } catch (error) {
                showStatus('Error deleting chat: ' + error.message, 'error');
            } finally {
                // Restore button
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `p-3 rounded-md mb-4 ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            statusDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const chatList = document.getElementById('chatList');
            
            if (show) {
                loadingIndicator.classList.remove('hidden');
                chatList.classList.add('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
                chatList.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
